############################
# @author EliasDH Team     #
# @see https://eliasdh.com #
# @since 01/01/2025        #
############################

# Physical Network Lab1 - DHCP / DNS
uci set network.lan201=interface
uci set network.lan201.proto='static'
uci set network.lan201.ipaddr='192.168.201.1'
uci set network.lan201.netmask='255.255.255.0'
uci commit network
/etc/init.d/network restart


uci set dhcp.lan201=dhcp
uci set dhcp.lan201.interface='lan201'
uci set dhcp.lan201.start='100'
uci set dhcp.lan201.limit='100'
uci set dhcp.lan201.leasetime='2h'
uci commit dhcp
/etc/init.d/dnsmasq restart
uci add_list dhcp.lan201.dhcp_option='3,192.168.201.1'
uci add_list dhcp.lan201.dhcp_option='6,8.8.8.8'
uci commit dhcp
/etc/init.d/dnsmasq restart
uci set network.lan201.device='br-lan'
uci commit network
/etc/init.d/network restart
uci delete network.lan
uci commit network
/etc/init.d/network restart
uci add dhcp host
uci set dhcp.@host[-1].name='student-pc1'
uci set dhcp.@host[-1].ip='192.168.201.90'
uci set dhcp.@host[-1].mac='00:e0:4c:55:74:ba'
uci set dhcp.@host[-1].dns='1'
uci add dhcp host
uci set dhcp.@host[-1].name='docent-pc1'
uci set dhcp.@host[-1].ip='192.168.201.99'
uci set dhcp.@host[-1].mac='38:ba:f8:8a:7c:0d'
uci set dhcp.@host[-1].dns='1'
uci commit dhcp
/etc/init.d/dnsmasq restart

# Physical Network Lab2 - NAT / Firewall
uci set dhcp.@dnsmasq[0].domain='labnet.local'
uci set dhcp.@dnsmasq[0].authoritative='1'
uci commit dhcp
/etc/init.d/dnsmasq restart
uci add_list dhcp.@dnsmasq[0].server='/ei.fti.uantwerpen.be/143.129.39.200'
uci add_list dhcp.@dnsmasq[0].server='143.169.252.201'
uci commit dhcp
/etc/init.d/dnsmasq restart
uci add dhcp domain
uci set dhcp.@domain[-1].name='router.labnet.local'
uci set dhcp.@domain[-1].ip='192.168.201.1'
uci commit dhcp
/etc/init.d/dnsmasq restart
echo "cname=cyber.ei.fti.uantwerpen.be,cybersecurity.ei.fti.uantwerpen.be" >> /etc/dnsmasq.conf
/etc/init.d/dnsmasq restart


uci set firewall.wan.masq='1'
uci commit firewall
/etc/init.d/firewall restart
uci set firewall.@zone[0].network='lan lan201'
uci set firewall.@zone[0].input='ACCEPT'
uci set firewall.@zone[0].output='ACCEPT'
uci set firewall.@zone[0].forward='ACCEPT'
uci set firewall.@zone[1].network='wan'
uci set firewall.@zone[1].input='REJECT'
uci set firewall.@zone[1].output='ACCEPT'
uci set firewall.@zone[1].forward='REJECT'
uci set firewall.@zone[1].masq='1'
uci add firewall forwarding
uci set firewall.@forwarding[-1].src='lan'
uci set firewall.@forwarding[-1].dest='wan'
uci add firewall redirect
uci set firewall.@redirect[-1].name='docent_web'
uci set firewall.@redirect[-1].src='wan'
uci set firewall.@redirect[-1].src_dport='8080'
uci set firewall.@redirect[-1].dest='lan'
uci set firewall.@redirect[-1].dest_ip='192.168.201.99'
uci set firewall.@redirect[-1].dest_port='80'
uci set firewall.@redirect[-1].proto='tcp'
uci add firewall redirect
uci set firewall.@redirect[-1].name='student_ssh'
uci set firewall.@redirect[-1].src='wan'
uci set firewall.@redirect[-1].src_dport='2020'
uci set firewall.@redirect[-1].dest='lan'
uci set firewall.@redirect[-1].dest_ip='192.168.201.90'
uci set firewall.@redirect[-1].dest_port='22'
uci set firewall.@redirect[-1].proto='tcp'
uci add firewall rule
uci set firewall.@rule[-1].name='Expose_LuCI_WAN'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].dest_port='80'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='ACCEPT'
uci commit firewall
/etc/init.d/firewall restart

uci add firewall rule # Only LAN IP 192.168.201.90 is allowed to SSH to the router
uci set firewall.@rule[-1].name='Allow_SSH_from_90'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].src_ip='192.168.201.90'
uci set firewall.@rule[-1].dest_port='22'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='ACCEPT'
uci add firewall rule
uci set firewall.@rule[-1].name='Deny_SSH_others'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].dest_port='22'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='DROP'
uci commit firewall
/etc/init.d/firewall restart
uci add firewall rule # Block ICMP on WAN
uci set firewall.@rule[-1].name='Block_ICMP_WAN'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].proto='icmp'
uci set firewall.@rule[-1].target='DROP'
uci commit firewall
/etc/init.d/firewall restart
uci add firewall rule # Log ALL dropped WAN traffic
uci set firewall.@rule[-1].name='Log_Dropped_WAN'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].proto='all'
uci set firewall.@rule[-1].target='DROP'
uci set firewall.@rule[-1].log='1'
uci commit firewall
/etc/init.d/firewall restart
uci delete firewall.@rule[Expose_LuCI_WAN] # Restrict exposed LuCI on WAN to 143.129.40.0/24
uci add firewall rule
uci set firewall.@rule[-1].name='Allow_LuCI_From_UAntwerp'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].src_ip='143.129.40.0/24'
uci set firewall.@rule[-1].dest_port='80'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='ACCEPT'
uci add firewall rule
uci set firewall.@rule[-1].name='Block_LuCI_Others'
uci set firewall.@rule[-1].src='wan'
uci set firewall.@rule[-1].dest_port='80'
uci set firewall.@rule[-1].proto='tcp'
uci set firewall.@rule[-1].target='DROP'
uci commit firewall
/etc/init.d/firewall restart
uci add firewall rule # Allow ICMP within LAN, but ICMP to router
uci set firewall.@rule[-1].name='Allow_ICMP_LAN_internal'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].dest='lan'
uci set firewall.@rule[-1].proto='icmp'
uci set firewall.@rule[-1].target='ACCEPT'
uci add firewall rule
uci set firewall.@rule[-1].name='Block_ICMP_to_router'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].proto='icmp'
uci set firewall.@rule[-1].target='DROP'
uci commit firewall
/etc/init.d/firewall restart


# Physical Network Lab3 - WiFi
opkg update
opkg install iperf3
opkg install hostapd-openssl # Required for WPA3 support

# Enable the 2.4GHz radio (radio0 is typically 2.4GHz)
uci set wireless.radio0.disabled='0'
uci set wireless.radio0.channel='auto'
uci set wireless.radio0.htmode='HT20'
uci set wireless.radio0.country='BE'
uci commit wireless

# Delete any existing default wireless interface if present
uci delete wireless.default_radio0 2>/dev/null

# Create new wireless interface for the Student SSID
uci set wireless.student_wifi=wifi-iface
uci set wireless.student_wifi.device='radio0'
uci set wireless.student_wifi.mode='ap'
uci set wireless.student_wifi.ssid='Student-s0250171'
uci set wireless.student_wifi.encryption='sae-mixed' # WPA2/WPA3 mixed mode
uci set wireless.student_wifi.key='password'
uci set wireless.student_wifi.network='lan201'# Assign to LAN network interface
uci set wireless.student_wifi.disabled='0'
uci set wireless.student_wifi.ieee80211w='1' # Management Frame Protection (optional for WPA3)
uci commit wireless